# Data
We use the [MetaShift](https://github.com/Weixin-Liang/MetaShift) dataset environments, follow the same procedure to download the [Visual Genome](https://github.com/Weixin-Liang/MetaShift#download-visual-genome) data. Have the downloaded files be in a directory named `genome_vision_data` and let it be in the same directory where `pirm` directory resides. 

### Generate Data for Domain Generalization Experiment
Generate the dataset using `dataset\domain_generalization_cat_dog_pirm_ii.py`. The data for each experiment in Table 2 (in the main text) can be regenerated by referring to the experiment index (1 to 4)
```
python dataset\domain_generalization_cat_dog_pirm_ii.py
--dataset_name: the output directory for the generated data 
--add_p: the percentage of overlap between the two domains, options = {0,0.10,0.25}
--mp: minority percenrage, options = {0.01, 0.12} 
--images_folder: the directory where 'genome_vision_data/data/GQA/allImages/images/' is
```
- The output directory looks like following. The set of samples in `p1` is the one closer to the test data in terms of distance. 
```
/data/Domain-Generalization-Cat-Dog-pirmii-exp1-A

├── p1
    ├── imageID_to_group.pkl
    ├── train/
        ├── cat/
        ├── dog/ 
    ├── test/
        ├── cat/
        ├── dog/ 
    ├── val_out_of_domain/
        ├── cat/
        ├── dog/ 
├── irm
    ├── imageID_to_group.pkl
    ├── train/
        ├── cat/
        ├── dog/ 
    ├── test/
        ├── cat/
        ├── dog/ 
    ├── val_out_of_domain/
        ├── cat/
        ├── dog/ 
 ```
### Generate Data for Subpopulationshifts Experiment
Generate the dataset using `dataset\create_subpopulation_pirm_ii.py`. The data for each experiment in Table 6 and 7 (in the appendix) can be regenerated by referring number of `p`, and `mp`. 
```
python dataset\create_subpopulation_pirm_ii.py
--dataset_name: the output directory for the generated data 
--add_p: the percentage of overlap between the two domains, options = {0,0.10,0.25}
--experiment_index: the experiment number referencing the main text (table 2), options = {1,2,3,4} 
--images_folder: the directory where 'genome_vision_data/data/GQA/allImages/images/' is
```
- The output directory looks like following. Here `p1` and `p2` include samples from `indoor` and `outdoor` respectively. 
```
├── p1
    ├── imageID_to_group.pkl
    ├── train/
        ├── cat/
        ├── dog/ 
    ├── test/
        ├── cat/
        ├── dog/ 
    ├── val_out_of_domain/
        ├── cat/
        ├── dog/ 
├── p2
    ├── imageID_to_group.pkl
    ├── train/
        ├── cat/
        ├── dog/ 
    ├── test/
        ├── cat/
        ├── dog/ 
    ├── val_out_of_domain/
        ├── cat/
        ├── dog/ 
├── irm
    ├── imageID_to_group.pkl
    ├── train/
        ├── cat/
        ├── dog/ 
    ├── test/
        ├── cat/
        ├── dog/ 
    ├── val_out_of_domain/
        ├── cat/
        ├── dog/ 
```
# Experiments
Running an experiment using `train.py`
```
python train.py
--irm_penalty: integer for IRM penality
--irm_anneal: integer for IRM annealing iterations
--ibirm_penalty: integer for IB_IRM penalty
--ibirm_anneal: integer for IB_IRM annealing iterations
--seed: integer
--experiment: a string of options either 'DG' for domain generalization or 'SP' for subpopulation shifts
--algorithm: a string of options either 'irm', 'erm' or 'ibirm'
--output_dir: the directory of outputs 
--data_dir: generated data directory
--results_folder: final results directory
--partial: a flag of either to impose partial invariance or no. 
```
 
### Domain Generalization Example: 
- Run one experiment of IRM algorithm with partial invariance
 ```
python train.py \
    --irm_penalty 10 \
    --irm_anneal 20 \
    --seed 0 \
    --experiment 'DG' \
    --experiment_id 'experiment_exp1-A' \
    --algorithm 'irm' \
    --output_dir 'train_outputs/experiment_exp1-A' \
    --data_dir 'data/Domain-Generalization-Cat-Dog-pirmii-exp1-A' \
    --results_folder 'raw_results_dg_cats_dogs' \
    --partial
 ```


### Subpopulationshift Example:
- Run one experiment of IB_IRM without partial invariance
 ```
python train.py \
   --irm_penalty 10 \
   --irm_anneal 40 \
   --ibirm_penalty 10 \
   --ibirm_anneal 20 \
   --seed 0 \
   --experiment 'SP' \
   --experiment_id 'experiment_exp1-A' \
   --algorithm 'irm' \
   --output_dir 'reprod_01_25_output_sp' \
   --data_dir 'data/subpopulationshift_pirm_ii_exp1_A' \
   --results_folder 'raw_results_sps_cats_dogs' 
 ```
